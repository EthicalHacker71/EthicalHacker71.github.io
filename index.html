<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Puter AI — Advanced txt2img (GPT Image) Demo</title>

  <!-- Puter.js (no key needed) -->
  <script src="https://js.puter.com/v2/"></script>

  <!-- Zip helpers for "Download all" -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#9db1c7; --text:#e6eef6; --accent:#3b82f6; --accent-2:#22d3ee; --radius:14px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 10% -10%,rgba(34,211,238,.08),transparent 60%),radial-gradient(900px 500px at 100% 0,rgba(59,130,246,.08),transparent 60%),var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:48px auto;padding:0 20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35);backdrop-filter:blur(6px)}
    header.card{padding:20px 22px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:clamp(18px,1.6vw + 14px,28px);margin:0;letter-spacing:.2px}
    header .sub{color:var(--muted);font-size:14px}
    .controls{margin-top:18px;padding:18px;display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){.controls{grid-template-columns:1fr}}
    .stack{display:flex;flex-direction:column;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    label span{font-size:13px;color:var(--muted)}
    textarea,select,input{width:100%;background:var(--panel);color:var(--text);border-radius:10px;border:1px solid rgba(255,255,255,.08);padding:12px 14px;outline:none;font-size:15px;transition:border-color .2s,box-shadow .2s}
    textarea{min-height:110px;resize:vertical}
    select:focus,textarea:focus,input:focus{border-color:rgba(34,211,238,.45);box-shadow:0 0 0 4px rgba(34,211,238,.12)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end;padding:0 18px 18px}
    button{appearance:none;border:1px solid transparent;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;transition:transform .04s ease,box-shadow .2s,background .2s,border-color .2s}
    button:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#06121d;box-shadow:0 8px 20px rgba(34,211,238,.25)}
    .btn-ghost{background:transparent;border-color:rgba(255,255,255,.12);color:var(--text)}
    .btn-danger{background:transparent;border-color:rgba(239,68,68,.6);color:#fecaca}
    .gallery{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .imgcard{background:#0e151d;border:1px solid rgba(255,255,255,.06);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .imgwrap{position:relative;width:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#0a0f15}
    .imgwrap img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .imgtools{display:flex;gap:8px;padding:10px;justify-content:space-between;align-items:center;border-top:1px solid rgba(255,255,255,.06)}
    .small{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .status{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:14px;padding:0 18px 18px}
    .hidden{display:none!important}
    .pill{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.1);border-radius:999px;background:rgba(255,255,255,.02)}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){.row-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div>
        <h1>GPT Image — Advanced Text→Image (Puter AI)</h1>
        <div class="sub">Batch generation, size controls, prompt splitting, and ZIP download — using <code>puter.ai.txt2img()</code>.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn-ghost" href="https://puter.ai" target="_blank" rel="noopener noreferrer" style="text-decoration:none;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);color:inherit">Docs ↗</a>
      </div>
    </header>

    <section class="card controls">
      <div class="stack">
        <label>
          <span>Prompt</span>
          <textarea id="prompt" placeholder="One or many prompts. If multi-split is ON, choose delimiter below."></textarea>
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="surprise" class="btn-ghost">Surprise me</button>
          <button id="copyPrompt" class="btn-ghost">Copy prompt</button>
          <span id="chars" class="pill">0 chars</span>
        </div>
      </div>

      <div class="stack">
        <div class="grid">
          <label>
            <span>Model</span>
            <select id="model">
              <option value="gpt-image-1" selected>gpt-image-1</option>
              <option value="gpt-image-1-mini">gpt-image-1-mini</option>
            </select>
          </label>
          <label>
            <span>Batch (images per prompt)</span>
            <select id="count">
              <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </label>
          <label>
            <span>Aspect preview</span>
            <select id="aspect">
              <option value="1/1" selected>Square 1:1</option>
              <option value="3/4">Portrait 3:4</option>
              <option value="4/3">Landscape 4:3</option>
              <option value="16/9">Widescreen 16:9</option>
            </select>
          </label>
        </div>

        <!-- Size controls (default 6000x6000) -->
        <div class="row-2">
          <label>
            <span>Width (px)</span>
            <input id="width" type="number" min="64" max="8192" step="1" value="6000" />
          </label>
          <label>
            <span>Height (px)</span>
            <input id="height" type="number" min="64" max="8192" step="1" value="6000" />
          </label>
        </div>

        <!-- Multi-prompt controls -->
        <div class="row-2">
          <label style="display:flex;align-items:center;gap:8px">
            <input id="multi" type="checkbox" />
            <span class="pill">Split prompts</span>
          </label>
          <label>
            <span>Delimiter</span>
            <select id="delimiter">
              <option value="newline" selected>Newline (\n)</option>
              <option value="blankline">Blank line</option>
              <option value="comma">Comma (,)</option>
              <option value="semicolon">Semicolon (;)</option>
              <option value="pipe">Pipe (|)</option>
              <option value="space">Single space</option>
            </select>
          </label>
        </div>

        <!-- Format controls -->
        <div class="row-2">
          <label>
            <span>Download format</span>
            <select id="format">
              <option value="png" selected>PNG (lossless)</option>
              <option value="jpeg">JPG (compressed)</option>
            </select>
          </label>
          <label id="jpegControls" class="hidden">
            <span>JPEG quality (0.1–1.0)</span>
            <input id="quality" type="number" min="0.1" max="1" step="0.1" value="0.9" />
          </label>
        </div>

        <div class="actions" style="padding:0">
          <button id="generate" class="btn-primary">Generate</button>
          <button id="stop" class="btn-danger">Stop</button>
          <button id="downloadAll" class="btn-ghost">Download all (zip)</button>
          <button id="clear" class="btn-ghost">Clear gallery</button>
        </div>
      </div>
    </section>

    <section class="status hidden" id="status">
      <div class="pill" id="statusText">Idle</div>
      <div class="pill" id="progress">0/0</div>
    </section>

    <section class="gallery" id="gallery" aria-live="polite"></section>
  </div>

  <script>
    const els = {
      prompt: document.getElementById('prompt'),
      model: document.getElementById('model'),
      count: document.getElementById('count'),
      aspect: document.getElementById('aspect'),
      gen: document.getElementById('generate'),
      stop: document.getElementById('stop'),
      clear: document.getElementById('clear'),
      status: document.getElementById('status'),
      statusText: document.getElementById('statusText'),
      progress: document.getElementById('progress'),
      gallery: document.getElementById('gallery'),
      chars: document.getElementById('chars'),
      surprise: document.getElementById('surprise'),
      copyPrompt: document.getElementById('copyPrompt'),
      downloadAll: document.getElementById('downloadAll'),
      format: document.getElementById('format'),
      jpegControls: document.getElementById('jpegControls'),
      quality: document.getElementById('quality'),
      width: document.getElementById('width'),
      height: document.getElementById('height'),
      multi: document.getElementById('multi'),
      delimiter: document.getElementById('delimiter')
    };

    const presets = [
      'A futuristic cityscape at night, neon rain, reflective streets, cinematic ultrawide, volumetric fog, highly detailed',
      'A cozy reading nook with warm lamp light, rain on the window, soft bokeh, film grain, shallow depth of field',
      'A photorealistic robot barista serving coffee, stainless steel textures, natural morning light, 50mm lens',
      'An ancient library hidden in a forest, golden hour, god rays through trees, ethereal atmosphere, high detail',
      'An isometric pixel art cyberpunk alley, vending machines, animated neon signs, rainy vibes'
    ];

    let cancel = false;

    function ensureAPI(){
      if (!('puter' in window)) throw new Error('Puter JS SDK not loaded.');
      if (!('ai' in puter) || typeof puter.ai.txt2img !== 'function') throw new Error('puter.ai.txt2img() is unavailable.');
    }

    function setBusy(active, text='Generating…'){ els.status.classList.toggle('hidden', !active); els.statusText.textContent = text; }
    function setProgress(i, n){ els.progress.textContent = `${i}/${n}`; }

    function filenameFromPrompt(prompt, i, ext){
      const base = prompt.trim().slice(0, 60).replace(/[^a-z0-9]+/gi,'-').replace(/(^-|-$)/g,'').toLowerCase() || 'image';
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      return `${base}-${i}-${ts}.${ext}`;
    }

    // Robust conversion: fetch Blob → draw to 6000×6000 (or chosen) canvas → export PNG/JPEG
    async function convertImageElement(imgEl, format, quality=0.92, targetW, targetH){
      try{
        const resp = await fetch(imgEl.src);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        const img = new Image();
        img.src = url;
        await img.decode();

        const w = Math.max(1, parseInt(targetW||img.naturalWidth,10));
        const h = Math.max(1, parseInt(targetH||img.naturalHeight,10));

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        URL.revokeObjectURL(url);

        const mime = format === 'jpeg' ? 'image/jpeg' : 'image/png';
        const dataUrl = canvas.toDataURL(mime, format === 'jpeg' ? quality : undefined);

        const out = new Image();
        out.src = dataUrl;
        out.alt = imgEl.alt || '';
        await out.decode();

        out.dataset.mime = mime;
        out.dataset.format = format;
        out.dataset.w = String(w);
        out.dataset.h = String(h);
        return out;
      }catch(e){
        imgEl.dataset.mime = 'image/png';
        imgEl.dataset.format = 'png';
        return imgEl;
      }
    }

    function addToGallery(img, prompt, model, idx){
      const card = document.createElement('div'); card.className = 'imgcard';
      const wrap = document.createElement('div'); wrap.className = 'imgwrap';
      const ratio = els.aspect.value.split('/').map(Number); if(ratio.length===2){ wrap.style.aspectRatio = `${ratio[0]} / ${ratio[1]}`; }
      img.alt = prompt; img.loading = 'lazy';
      wrap.appendChild(img);

      const tools = document.createElement('div'); tools.className = 'imgtools';
      const meta = document.createElement('div'); meta.className = 'small';
      const w = img.dataset.w || '—'; const h = img.dataset.h || '—';
      meta.textContent = `${model} · ${prompt.slice(0,64)}${prompt.length>64?'…':''} · ${w}×${h}`;

      const ext = img.dataset.format || (els.format.value === 'jpeg' ? 'jpeg' : 'png');

      const dl = document.createElement('a'); dl.className = 'btn-ghost'; dl.textContent = 'Download';
      dl.download = filenameFromPrompt(prompt, idx, ext);
      dl.href = img.src;

      const copyBtn = document.createElement('button'); copyBtn.className = 'btn-ghost'; copyBtn.textContent = 'Copy image';
      copyBtn.onclick = async ()=>{
        try{
          const blob = await (await fetch(img.src)).blob();
          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        }catch(e){ alert('Copy failed. Your browser may not support ClipboardItem.'); }
      };

      tools.appendChild(meta); tools.appendChild(copyBtn); tools.appendChild(dl);
      card.appendChild(wrap); card.appendChild(tools); els.gallery.prepend(card);
    }

    function parsePrompts(raw){
      const s = (raw||'').trim();
      if(!s) return [];
      if(!els.multi.checked) return [s];
      const d = els.delimiter.value;
      let parts = [];
      switch(d){
        case 'newline': parts = s.split(/\n+/); break;
        case 'blankline': parts = s.split(/\n\s*\n+/); break;
        case 'comma': parts = s.split(/\s*,\s*/); break;
        case 'semicolon': parts = s.split(/\s*;\s*/); break;
        case 'pipe': parts = s.split(/\s*\|\s*/); break;
        case 'space': parts = s.split(/\s+/); break;
        default: parts = [s];
      }
      return parts.map(x=>x.trim()).filter(Boolean);
    }

    async function generateBatch(){
      const prompts = parsePrompts(els.prompt.value);
      if(!prompts.length){ els.prompt.focus(); return; }
      const model = els.model.value; const n = parseInt(els.count.value,10) || 1;
      const outFormat = els.format.value; const quality = Number(els.quality.value || 0.9);
      const targetW = parseInt(els.width.value||6000,10);
      const targetH = parseInt(els.height.value||6000,10);

      cancel = false; setBusy(true, 'Generating…'); setProgress(0, n * prompts.length);
      try{ ensureAPI(); }catch(e){ setBusy(false); alert(e.message); return; }

      let k = 0;
      for(const p of prompts){
        for(let i=1;i<=n;i++){
          if(cancel){ setBusy(false, 'Canceled'); return; }
          setProgress(k++, n * prompts.length);
          try{
            // Use only model for maximum compatibility; enforce final size via canvas
            const rawImgEl = await puter.ai.txt2img(p, { model });
            const finalImg = await convertImageElement(rawImgEl, outFormat, quality, targetW, targetH);
            addToGallery(finalImg, p, model, i);
          }catch(err){ console.error(err); alert(err?.message || 'Generation failed.'); }
        }
      }
      setProgress(n * prompts.length, n * prompts.length);
      setBusy(false, 'Done');
    }

    async function downloadAllZip(){
      const imgs = Array.from(document.querySelectorAll('.imgwrap img'));
      if(!imgs.length){ alert('No images to download.'); return; }
      const zip = new JSZip();
      let i = 1;
      for(const img of imgs){
        const resp = await fetch(img.src);
        const blob = await resp.blob();
        const arrBuf = await blob.arrayBuffer();
        const ext = (img.dataset.format || 'png').replace('jpg','jpeg');
        const name = filenameFromPrompt(img.alt || 'image', i++, ext);
        zip.file(name, arrBuf);
      }
      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, 'images.zip');
    }

    // UI wiring
    els.gen.addEventListener('click', generateBatch);
    els.stop.addEventListener('click', ()=>{ cancel = true; setBusy(false, 'Canceled'); });
    els.clear.addEventListener('click', ()=>{ els.gallery.innerHTML=''; setProgress(0,0); });
    els.downloadAll.addEventListener('click', downloadAllZip);

    els.surprise.addEventListener('click', ()=>{ els.prompt.value = presets[Math.floor(Math.random()*presets.length)]; updateCharCount(); });
    els.copyPrompt.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(els.prompt.value||''); }catch{} });
    function updateCharCount(){ els.chars.textContent = `${(els.prompt.value||'').length} chars`; }
    els.prompt.addEventListener('input', updateCharCount);

    function updateFormatUI(){ els.jpegControls.classList.toggle('hidden', els.format.value !== 'jpeg'); }
    els.format.addEventListener('change', updateFormatUI);

    // Defaults
    els.prompt.value = presets[0]; updateCharCount(); updateFormatUI();
    try{ els.multi.checked = JSON.parse(localStorage.getItem('multi_split')||'false'); }catch{}
    els.multi.addEventListener('change', ()=>{ try{ localStorage.setItem('multi_split', JSON.stringify(els.multi.checked)); }catch{} });
  </script>
</body>
</html>
